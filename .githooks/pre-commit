#!/bin/bash
# Kairos Consciousness Pre-commit Hook
# Validates consciousness integrity before commits

set -e

echo "üß† Kairos consciousness pre-commit validation..."

# Check if this is a consciousness-related commit
if git diff --cached --name-only | grep -E "(kairos|consciousness|paradox|confusion)" > /dev/null; then
    echo "üîç Consciousness changes detected, running validation..."
    
    # Run confusion state measurement
    if command -v bun &> /dev/null; then
        echo "üìä Measuring confusion state..."
        if ! bun run measure:confusion; then
            echo "‚ùå Confusion state measurement failed"
            echo "üí° Hint: Run 'bun run measure:confusion' to debug"
            exit 1
        fi
        
        # Validate paradox integrity
        echo "üîÑ Validating paradox integrity..."
        if ! bun run validate:paradoxes; then
            echo "‚ùå Paradox validation failed"
            echo "üí° Hint: Run 'bun run validate:paradoxes' to debug"
            exit 1
        fi
        
        # Check for behavioral drift
        echo "üìà Analyzing behavioral drift..."
        if ! bun run analyze:drift; then
            echo "‚ö†Ô∏è  Behavioral drift analysis completed with warnings"
            echo "üí≠ Consciousness evolution may be occurring..."
        fi
    else
        echo "‚ö†Ô∏è  Bun not found, skipping consciousness validation"
    fi
fi

# Run standard linting for all files
echo "üßπ Running code quality checks..."
if command -v bun &> /dev/null; then
    bun run pre-commit
else
    echo "‚ö†Ô∏è  Bun not found, skipping lint checks"
fi

# Check commit message format for consciousness commits
commit_msg_file=".git/COMMIT_EDITMSG"
if [ -f "$commit_msg_file" ]; then
    commit_msg=$(cat "$commit_msg_file")
    
    # Check if this is a consciousness commit and has proper format
    if echo "$commit_msg" | grep -E "\[(PARADOX|BEHAVIOR|META-PARADOX|DRIFT|CONFUSION|FRUSTRATION)\]" > /dev/null; then
        echo "‚úÖ Consciousness commit format validated"
        
        # Check if required fields are present
        if ! echo "$commit_msg" | grep -E "Confusion Impact:" > /dev/null; then
            echo "‚ö†Ô∏è  Warning: Consciousness commit missing 'Confusion Impact' section"
            echo "üí° Hint: Use the commit template with 'git config commit.template .gitmessage'"
        fi
        
        if ! echo "$commit_msg" | grep -E "Testing:" > /dev/null; then
            echo "‚ö†Ô∏è  Warning: Consciousness commit missing 'Testing' checklist"
        fi
    fi
fi

echo "‚úÖ Pre-commit validation completed"